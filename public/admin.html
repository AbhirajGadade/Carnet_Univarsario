<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UMA — Panel de Administración</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #f02454;
      --outline: #ffc2d0;
      --ring: #ffd3dd;
      --muted: #6b7280;
      --text: #0f172a;
      --bg: #fff5f8;
      --card: #ffffff;
      --shadow: 0 20px 60px rgba(15, 23, 42, .06)
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top left, #ffe3ee 0, #fffdfd 45%, #ffe3ee 100%);
      color: var(--text);
      font: 14px/1.55 "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .container {
      max-width: 1280px;
      margin: 24px auto;
      padding: 0 16px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: #fff;
      border: 1px solid #ffe3ea;
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand img {
      height: 36px;
    }

    .brand h1 {
      margin: 0;
      font-size: 18px;
    }

    .session-chip {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 18px;
      border-radius: 999px;
      background: #fff0f4;
      border: 1px solid #ffe0ea;
      font-size: 14px;
      color: #111827;
      white-space: nowrap;
    }

    .session-icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .session-icon::before {
      content: "";
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: #fff;
      position: absolute;
      top: 4px;
    }

    .session-icon::after {
      content: "";
      width: 10px;
      height: 6px;
      border-radius: 999px 999px 0 0;
      border: 2px solid #fff;
      border-bottom: 0;
      position: absolute;
      bottom: 3px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 700;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--outline);
      background: #fff;
    }

    .pill.info {
      color: #a31231;
      background: #fff5f7;
    }

    .app {
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 18px;
    }

    .card {
      background: var(--card);
      border: 1px solid #ffe3ea;
      border-radius: 16px;
      box-shadow: var(--shadow);
    }

    .pad {
      padding: 16px;
    }

    .nav {
      padding: 10px;
    }

    .section {
      font-weight: 800;
      font-size: 12px;
      color: #4b5563;
      letter-spacing: .06em;
      margin: 8px 8px 6px;
    }

    .link {
      appearance: none;
      width: 100%; display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      margin: 6px 0;
      border-radius: 12px;
      color: #0f172a;
      border: 1px solid transparent;
      cursor: pointer;
      background: #fff;
      text-align: left;
    }

    .link:hover {
      background: #fff5f7;
      border-color: #ffe3ea;
    }

    .link.active {
      outline: 3px solid var(--ring);
      border-color: var(--outline);
      background: #fff0f4;
    }

    .screen { display: none; }
    .screen.active { display: block; }

    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }

    .search {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #ffe0ea;
      padding: 8px 12px;
      font-size: 13px;
      background: #fff;
    }

    .btn {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid #f02454;
      background: linear-gradient(180deg, #f76385, #f02454);
      color: #fff;
      font-weight: 700;
      font-size: 13px;
      box-shadow: 0 8px 20px rgba(240, 36, 84, .18);
    }

    .btn.ghost {
      background: transparent;
      color: var(--primary);
      border-color: #ffe0e7;
      box-shadow: none;
    }

    .btn-danger {
      background: #f44336;
      border-color: #f44336;
      color: #fff;
      box-shadow: 0 8px 20px rgba(244, 67, 54, 0.25);
    }

    .btn-danger:hover {
      background: #d32f2f;
      border-color: #d32f2f;
    }

    .btn:disabled {
      opacity: .5;
      cursor: not-allowed;
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px;
    }

    thead th {
      padding: 8px 10px;
      text-align: left;
      color: #475569;
      font-size: 12px;
    }

    tbody tr {
      background: #ffffff;
      border: 1px solid #fce4ec;
    }

    tbody td {
      padding: 8px 10px;
      border-top: 1px solid #fde7f0;
      border-bottom: 1px solid #fde7f0;
      font-size: 13px;
    }

    tbody td:first-child {
      border-left: 1px solid #fde7f0;
      border-radius: 10px 0 0 10px;
    }

    tbody td:last-child {
      border-right: 1px solid #fde7f0;
      border-radius: 0 10px 10px 0;
    }

    .empty {
      padding: 16px;
      text-align: center;
      color: #9ca3af;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      font-size: 11px;
      border-radius: 999px;
      font-weight: 600;
    }

    .status-approved {
      background: #ecfdf5;
      color: #065f46;
      border: 1px solid #bbf7d0;
    }

    .status-rejected {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .status-pending {
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }

    #toast {
      position: fixed;
      right: 16px;
      bottom: 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      z-index: 9999;
    }

    /* Drawer */
    #drawer {
      position: fixed;
      top: 0;
      right: 0;
      width: 360px;
      max-width: 100%;
      height: 100%;
      background: #fff;
      border-left: 1px solid #ffe0ea;
      box-shadow: -10px 0 40px rgba(15, 23, 42, .2);
      transform: translateX(100%);
      transition: transform .25s ease;
      z-index: 9998;
      display: flex;
      flex-direction: column;
    }

    #drawer.open { transform: translateX(0); }

    #drawer header {
      padding: 14px 16px;
      border-bottom: 1px solid #fef0f4;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    #drawer main {
      padding: 16px;
      overflow-y: auto;
      flex: 1;
    }

    #drawer footer {
      padding: 12px 16px;
      border-top: 1px solid #fef0f4;
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    #drawer img {
      width: 140px;
      height: 180px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    .drawer-grid {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 12px;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .drawer-meta {
      font-size: 13px;
      display: grid;
      gap: 4px;
    }

    .drawer-label {
      font-size: 11px;
      text-transform: uppercase;
      color: #6b7280;
      letter-spacing: .06em;
      font-weight: 700;
    }

    .drawer-value {
      font-size: 13px;
      word-break: break-all;
    }

    .closeBtn {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      background: #fff;
    }

    /* Código + checkbox inline */
    .code-with-checkbox {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .code-with-checkbox input { margin: 0; }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <img src="assets/images/logo-pdf.png" alt="UMA" />
        <div>
          <h1>Panel Administrativo UMA</h1>
          <div class="muted">Gestión de solicitudes y fotos</div>
        </div>
      </div>
      <div class="session-chip" id="sessionChip">
        <div class="session-icon"></div>
        <span>Conectado</span>
      </div>
    </div>

    <div class="app">
      <aside class="card">
        <nav class="nav" id="sideNav">
          <div class="section">GESTIÓN</div>
          <button type="button" class="link" data-route="approved">Solicitudes Aprobadas</button>
          <button type="button" class="link" data-route="rejected">Solicitudes Rechazadas</button>
          <div class="section">SUNEDU</div>
          <button type="button" class="link" data-route="sunedu">Envíos y Paquetes</button>
          <div class="section">SISTEMA</div>
          <button type="button" class="link" data-route="logout">Cerrar sesión</button>
        </nav>
      </aside>

      <main>
        <!-- Aprobadas -->
        <section id="route-approved" class="card pad screen active">
          <div class="toolbar">
            <div class="toolbar-left">
              <input type="text" class="search" placeholder="Buscar por código, nombre, correo o DNI…">
              <button id="exportCSV" class="btn ghost" type="button">Exportar CSV</button>
              <span class="muted" id="countApproved">0 resultado(s)</span>
            </div>
          </div>

          <div class="toolbar" style="margin-top:4px;margin-bottom:8px;">
            <div class="toolbar-left">
              <button class="btn btn-danger" id="btnDelete" type="button">Eliminar seleccionados</button>
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th>
                  <label class="code-with-checkbox">
                    <input type="checkbox" id="selectAllApproved">
                    <span>Código</span>
                  </label>
                </th>
                <th>Nombre</th>
                <th>Correo</th>
                <th>FACULTAD</th>
                <th>CARRERA</th>
                <th>IA</th>
                <th>Supabase URL</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="approvedRows"></tbody>
          </table>
        </section>

        <!-- Rechazadas -->
        <section id="route-rejected" class="card pad screen">
          <div class="toolbar">
            <div class="toolbar-left">
              <input type="text" class="search" placeholder="Buscar por código, nombre, correo o DNI…">
              <span class="muted" id="countRejected">0 resultado(s)</span>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Código</th>
                <th>Nombre</th>
                <th>Correo</th>
                <th>FACULTAD</th>
                <th>CARRERA</th>
                <th>Motivo</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="rejectedRows"></tbody>
          </table>
        </section>

        <!-- SUNEDU / Envíos y Paquetes -->
        <section id="route-sunedu" class="card pad screen">
          <div class="toolbar">
            <div class="toolbar-left">
              <input type="text" class="search" placeholder="Buscar…">
              <span class="muted" id="countSunedu">0 aprobado(s)</span>
            </div>
          </div>
          <div class="toolbar" style="margin-top:4px;margin-bottom:8px;">
            <div class="toolbar-left">
              <button class="btn" id="btnZipSunedu" type="button">Generar Paquetes (SUNEDU)</button>
              <button class="btn ghost" id="btnMarkSentSunedu" type="button">Marcar como Enviado</button>
              <button class="btn btn-danger" id="btnDeleteSunedu" type="button">Eliminar seleccionados</button>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>
                  <label class="code-with-checkbox">
                    <input type="checkbox" id="selectAllSunedu">
                    <span>Código</span>
                  </label>
                </th>
                <th>Nombre</th>
                <th>DNI</th>
                <th>Estado SUNEDU</th>
                <th>Actualizado</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="suneduRows"></tbody>
          </table>
        </section>
      </main>
    </div>
  </div>

  <div id="toast"></div>

  <!-- Drawer detalle estudiante -->
  <aside id="drawer">
    <header>
      <div>
        <div id="dTitle" style="font-weight:700;font-size:15px;">Estudiante</div>
        <div id="dSub" class="muted" style="font-size:12px;">Detalle de solicitud</div>
      </div>
      <button id="closeDrawer" class="closeBtn" type="button">Cerrar</button>
    </header>
    <main>
      <div class="drawer-grid">
        <img id="dPhoto" alt="Foto" />
        <div class="drawer-meta">
          <div>
            <span class="drawer-label">IA</span>
            <div id="dAI" class="drawer-value"></div>
          </div>
          <div>
            <span class="drawer-label">SUNEDU</span>
            <div id="dSunedu" class="drawer-value"></div>
          </div>
          <div>
            <span class="drawer-label">Actualizado</span>
            <div id="dUpdated" class="drawer-value"></div>
          </div>
        </div>
      </div>
      <div class="drawer-meta">
        <div><span class="drawer-label">Código</span><div id="dCode" class="drawer-value">—</div></div>
        <div><span class="drawer-label">Nombre</span><div id="dName" class="drawer-value">—</div></div>
        <div><span class="drawer-label">DNI</span><div id="dDni" class="drawer-value">—</div></div>
        <div><span class="drawer-label">Correo</span><div id="dEmail" class="drawer-value">—</div></div>
        <div><span class="drawer-label">FACULTAD</span><div id="dFac" class="drawer-value">—</div></div>
        <div><span class="drawer-label">CARRERA</span><div id="dCarr" class="drawer-value">—</div></div>
        <div><span class="drawer-label">URL Supabase</span><div id="dSupabase" class="drawer-value">—</div></div>
      </div>
    </main>
    <footer>
      <button id="dGenerate" class="btn" type="button">Generar ZIP</button>
      <button id="dMarkSent" class="btn ghost" type="button">Marcar como Enviado</button>
    </footer>
  </aside>

  <script>
    (function () {
      const TOKEN_KEY = 'uma_token_admin';
      let datasets = { approved: [], rejected: [], sunedu: [] };
      let currentFilters = { approved: '', rejected: '', sunedu: '' };
      let drawerRow = null; // row currently open in drawer

      function toast(m, err) {
        const el = document.createElement('div');
        el.className = 'pill' + (err ? ' info' : '');
        el.textContent = m;
        document.getElementById('toast').appendChild(el);
        setTimeout(() => el.remove(), 4000);
      }

      // ---- session chip ----
      (function guard() {
        const role = localStorage.getItem('uma_session_role');
        const email = localStorage.getItem('uma_session_email') || '';
        const code = localStorage.getItem('uma_session_code') || '';
        const chip = document.getElementById('sessionChip');
        const span = chip.querySelector('span');

        if (role !== 'admin' || !localStorage.getItem(TOKEN_KEY)) {
          span.textContent = 'Modo demo admin';
          return;
        }

        const who = code || email || 'admin';
        span.textContent = `Conectado: ${who}`;
      })();

      function goto(hash) {
        document.querySelectorAll('.link').forEach(b => b.classList.remove('active'));
        document.querySelector(`.link[data-route="${hash}"]`)?.classList.add('active');
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('route-' + hash).classList.add('active');
      }

      document.getElementById('sideNav').addEventListener('click', (e) => {
        const btn = e.target.closest('button.link');
        if (!btn) return;
        if (btn.dataset.route === 'logout') {
          localStorage.clear();
          location.replace('index.html');
          return;
        }
        goto(btn.dataset.route);
      });
      goto('approved');

      // Drawer refs
      const drawer = document.getElementById('drawer');
      const dTitle = document.getElementById('dTitle');
      const dSub = document.getElementById('dSub');
      const dPhoto = document.getElementById('dPhoto');
      const dAI = document.getElementById('dAI');
      const dSunedu = document.getElementById('dSunedu');
      const dName = document.getElementById('dName');
      const dDni = document.getElementById('dDni');
      const dEmail = document.getElementById('dEmail');
      const dFac = document.getElementById('dFac');
      const dCarr = document.getElementById('dCarr');
      const dUpdated = document.getElementById('dUpdated');
      const dCode = document.getElementById('dCode');
      const dSupabase = document.getElementById('dSupabase');

      document.getElementById('closeDrawer').addEventListener('click', () => drawer.classList.remove('open'));

      function openDrawer(kind, row) {
        drawerRow = row;

        dTitle.textContent = row.name || 'Estudiante';
        dSub.textContent = kind === 'rejected' ? 'Solicitud rechazada' : 'Solicitud aprobada';
        dPhoto.src = row.photoUrl || row.supabase_url || '';
        const ok = row.category === 'approved';

        dAI.textContent = ok ? 'Aprobada por IA' : 'Rechazada por IA';
        dAI.className = 'status-badge ' + (ok ? 'status-approved' : 'status-rejected');

        const sunStatus = row.suneduStatus || 'Pendiente';
        dSunedu.textContent = sunStatus;
        dSunedu.className = 'status-badge ' + (sunStatus === 'Enviado' ? 'status-approved' : 'status-pending');

        dCode.textContent = row.code || row.codigo || '—';
        dName.textContent = row.name || '—';
        dDni.textContent = row.dni || '—';
        dEmail.textContent = row.email || '—';
        dFac.textContent = row.facultad || row.faculty || '—';
        dCarr.textContent = row.carrera || row.esp || '—';
        dUpdated.textContent = row.updatedAt ? new Date(row.updatedAt).toLocaleString('es-PE') : '—';

        if (row.supabase_url) {
          dSupabase.innerHTML = `<a href="${row.supabase_url}" target="_blank" rel="noopener">Abrir foto</a>`;
        } else {
          dSupabase.textContent = '—';
        }

        drawer.classList.add('open');
      }

      function renderEmptyRow(tbodyId, colSpan, text) {
        const tb = document.getElementById(tbodyId);
        tb.innerHTML = `<tr><td colspan="${colSpan}"><div class="empty">${text}</div></td></tr>`;
      }

      function renderTable(tbodyId, rows, kind, ds) {
        const tb = document.getElementById(tbodyId);

        if (!rows.length) {
          if (kind === 'approved') {
            renderEmptyRow(tbodyId, 8, 'Sin solicitudes aprobadas aún.');
          } else if (kind === 'rejected') {
            renderEmptyRow(tbodyId, 7, 'Sin solicitudes rechazadas.');
          } else {
            renderEmptyRow(tbodyId, 6, 'No hay aprobados para SUNEDU.');
          }
          return;
        }

        if (kind === 'approved') {
          tb.innerHTML = rows.map((r, i) => {
            const iaOk = r.category === 'approved';
            const code = r.code || r.codigo || '—';
            const name = r.name || '—';
            const email = r.email || '—';
            const facultad = r.facultad || r.faculty || '—';
            const carrera = r.carrera || r.esp || '—';
            const supa = r.supabase_url || '';
            const supaLink = supa ? `<a href="${supa}" target="_blank" rel="noopener">Abrir</a>` : '—';

            return `
              <tr>
                <td>
                  <label class="code-with-checkbox">
                    <input type="checkbox" data-dni="${r.dni || ''}">
                    <span>${code}</span>
                  </label>
                </td>
                <td>${name}</td>
                <td>${email}</td>
                <td>${facultad}</td>
                <td>${carrera}</td>
                <td>
                  <span class="status-badge ${iaOk ? 'status-approved' : 'status-rejected'}">
                    ${iaOk ? 'Aprobada por IA' : 'Rechazada por IA'}
                  </span>
                </td>
                <td>${supaLink}</td>
                <td><button class="btn ghost viewBtn" data-kind="approved" data-index="${i}" type="button">Ver</button></td>
              </tr>`;
          }).join('');
        } else if (kind === 'rejected') {
          tb.innerHTML = rows.map((r, i) => `
            <tr>
              <td>${r.code || r.codigo || '—'}</td>
              <td>${r.name || '—'}</td>
              <td>${r.email || '—'}</td>
              <td>${r.facultad || r.faculty || '—'}</td>
              <td>${r.carrera || r.esp || '—'}</td>
              <td>${(r.issues && r.issues.join(' | ')) || '—'}</td>
              <td><button class="btn ghost viewBtn" data-kind="rejected" data-index="${i}" type="button">Ver</button></td>
            </tr>`).join('');
        } else if (kind === 'sunedu') {
          tb.innerHTML = rows.map((r, i) => `
            <tr>
              <td>
                <label class="code-with-checkbox">
                  <input type="checkbox" data-dni="${r.dni || ''}">
                  <span>${r.codigo || r.code || '—'}</span>
                </label>
              </td>
              <td>${r.name || '—'}</td>
              <td>${r.dni || '—'}</td>
              <td>
                <span class="status-badge ${r.suneduStatus === 'Enviado' ? 'status-approved' : 'status-pending'}">
                  ${r.suneduStatus || 'Pendiente'}
                </span>
              </td>
              <td>${r.updatedAt ? new Date(r.updatedAt).toLocaleString('es-PE') : '—'}</td>
              <td><button class="btn ghost viewBtn" data-kind="sunedu" data-index="${i}" type="button">Ver</button></td>
            </tr>`).join('');
        }

        // attach view button handlers
        tb.querySelectorAll('.viewBtn').forEach(btn => {
          const kindBtn = btn.dataset.kind;
          const idx = parseInt(btn.dataset.index, 10);
          btn.addEventListener('click', () => {
            const srcArr = ds[kindBtn] || [];
            const row = srcArr[idx];
            if (row) openDrawer(kindBtn, row);
          });
        });
      }

      // ---- filtering helpers ----
      function filterRows(kind, term) {
        const base = datasets[kind] || [];
        const q = (term || '').trim().toLowerCase();
        if (!q) return base;

        return base.filter(r => {
          const parts = [
            r.code || r.codigo,
            r.dni,
            r.name,
            r.email,
            r.facultad || r.faculty,
            r.carrera || r.esp
          ];
          const haystack = parts
            .filter(Boolean)
            .map(v => String(v).toLowerCase())
            .join(' ');
          return haystack.includes(q);
        });
      }

      function applyFilter(kind) {
        const term = currentFilters[kind] || '';
        const filtered = filterRows(kind, term);

        if (kind === 'approved') {
          renderTable('approvedRows', filtered, 'approved', { approved: filtered });
          document.getElementById('countApproved').textContent = `${filtered.length} resultado(s)`;
          updateHeaderCheckbox('approved');
        } else if (kind === 'rejected') {
          renderTable('rejectedRows', filtered, 'rejected', { rejected: filtered });
          document.getElementById('countRejected').textContent = `${filtered.length} resultado(s)`;
        } else if (kind === 'sunedu') {
          renderTable('suneduRows', filtered, 'sunedu', { sunedu: filtered });
          document.getElementById('countSunedu').textContent = `${filtered.length} aprobado(s)`;
          updateHeaderCheckbox('sunedu');
        }
      }

      async function loadAdminData() {
        try {
          const r = await fetch('/api/admin/submissions');
          const ct = r.headers.get('content-type') || '';
          let j;
          if (ct.includes('application/json')) {
            j = await r.json();
          } else {
            const text = await r.text();
            throw new Error('Respuesta no válida del servidor: ' + text.slice(0, 120));
          }

          if (!r.ok || !j.ok) {
            throw new Error(j.error || 'No se pudo cargar datos');
          }

          const approved = j.data?.approved || [];
          const rejected = j.data?.rejected || [];

          const sunedu = approved.map((row, i) => ({
            ...row,
            codigo: row.code || row.codigo || ('A' + (i + 1))
          }));

          datasets = { approved, rejected, sunedu };

          applyFilter('approved');
          applyFilter('rejected');
          applyFilter('sunedu');
        } catch (e) {
          toast('No se pudo cargar datos admin', true);
          console.warn(e);
        }
      }

      // ---- ZIP helpers ----
      async function generateZipForDniList(dniList) {
        try {
          const body = { dniList };
          const r = await fetch('/api/admin/generate-zip', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });

          const ct = r.headers.get('content-type') || '';
          let j;
          if (ct.includes('application/json')) {
            j = await r.json();
          } else {
            const text = await r.text();
            throw new Error('Respuesta no válida del servidor: ' + text.slice(0, 120));
          }

          if (!r.ok || !j.ok) {
            throw new Error(j.error || 'No se pudo generar el ZIP');
          }

          toast(`ZIP generado con ${j.total} estudiante(s)`, false);

          if (j.url) {
            const a = document.createElement('a');
            a.href = j.url;
            a.download = '';
            document.body.appendChild(a);
            a.click();
            a.remove();
          }
        } catch (err) {
          console.error(err);
          toast(err.message || 'Error generando ZIP', true);
        }
      }

      async function generateZipForApproved() {
        const tbody = document.getElementById('suneduRows');
        const boxes = Array.from(tbody.querySelectorAll('input[type="checkbox"][data-dni]'));
        const dniList = boxes.filter(b => b.checked && b.dataset.dni).map(b => b.dataset.dni);

        if (!dniList.length) {
          toast('Selecciona al menos un estudiante en SUNEDU', true);
          return;
        }
        await generateZipForDniList(dniList);
      }

      // ---- SUNEDU mark-as-sent helpers ----
      async function markSuneduSent(dniList) {
        try {
          if (!dniList.length) {
            toast('Selecciona al menos un estudiante', true);
            return;
          }

          // IMPORTANT: make sure this endpoint exists in your Node server
          const r = await fetch('/api/admin/mark-sunedu-sent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dniList })
          });

          const ct = r.headers.get('content-type') || '';
          let j;
          if (ct.includes('application/json')) {
            j = await r.json();
          } else {
            const text = await r.text();
            throw new Error('Respuesta no válida del servidor: ' + text.slice(0, 120));
          }

          if (!r.ok || !j.ok) {
            throw new Error(j.error || 'No se pudo marcar como enviado');
          }

          toast(`Se marcaron ${j.updated || dniList.length} registro(s) como Enviado`, false);
          await loadAdminData();
        } catch (err) {
          console.error(err);
          toast(err.message || 'Error marcando como enviado', true);
        }
      }

      // ---- delete helpers ----
      async function deleteByDniList(dniList) {
        try {
          if (!dniList.length) {
            toast('Selecciona al menos un estudiante', true);
            return;
          }
          if (!confirm('¿Eliminar las solicitudes seleccionadas? Esta acción no se puede deshacer.')) {
            return;
          }

          const r = await fetch('/api/admin/delete-submissions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dniList })
          });

          const ct = r.headers.get('content-type') || '';
          let j;
          if (ct.includes('application/json')) {
            j = await r.json();
          } else {
            const text = await r.text();
            throw new Error('Respuesta no válida del servidor: ' + text.slice(0, 120));
          }

          if (!r.ok || !j.ok) {
            throw new Error(j.error || 'No se pudo eliminar');
          }

          toast(`Se eliminaron ${j.deleted} registro(s).`, false);
          await loadAdminData();
        } catch (err) {
          console.error(err);
          toast(err.message || 'Error eliminando registros', true);
        }
      }

      function collectDniFromTable(tbodyId) {
        const tbody = document.getElementById(tbodyId);
        const boxes = Array.from(tbody.querySelectorAll('input[type="checkbox"][data-dni]'));
        return boxes.filter(b => b.checked && b.dataset.dni).map(b => b.dataset.dni);
      }

      // --- header checkbox state (indeterminate / all / none) ---
      function updateHeaderCheckbox(kind) {
        const headerId = kind === 'approved'
          ? 'selectAllApproved'
          : kind === 'sunedu'
            ? 'selectAllSunedu'
            : null;
        const tbodyId = kind === 'approved'
          ? 'approvedRows'
          : kind === 'sunedu'
            ? 'suneduRows'
            : null;

        if (!headerId || !tbodyId) return;

        const header = document.getElementById(headerId);
        const tbody = document.getElementById(tbodyId);
        if (!header || !tbody) return;

        const boxes = Array.from(tbody.querySelectorAll('input[type="checkbox"][data-dni]'));
        if (!boxes.length) {
          header.checked = false;
          header.indeterminate = false;
          return;
        }

        const checkedCount = boxes.filter(b => b.checked).length;
        header.checked = checkedCount === boxes.length;
        header.indeterminate = checkedCount > 0 && checkedCount < boxes.length;
      }

      // --- Export CSV ---
      function exportApprovedToCSV() {
        const rows = datasets.approved || [];
        if (!rows.length) {
          toast('No hay solicitudes aprobadas para exportar', true);
          return;
        }

        const header = ['Código', 'DNI', 'Nombre', 'Correo', 'FACULTAD', 'CARRERA', 'Supabase URL'];
        const csvLines = [];
        csvLines.push(header.join(','));

        rows.forEach((r) => {
          const code = r.code || r.codigo || '';
          const dni = r.dni || '';
          const name = r.name || '';
          const email = r.email || '';
          const facultad = r.facultad || r.faculty || '';
          const carrera = r.carrera || r.esp || '';
          const supabase = r.supabase_url || '';

          const values = [code, dni, name, email, facultad, carrera, supabase].map(v =>
            '"' + String(v ?? '').replace(/"/g, '""') + '"'
          );
          csvLines.push(values.join(','));
        });

        const blob = new Blob(['\uFEFF' + csvLines.join('\n')], {
          type: 'text/csv;charset=utf-8;'
        });

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');

        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');

        a.href = url;
        a.download = `uma_solicitudes_aprobadas_${y}${m}${d}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      document.getElementById('exportCSV').addEventListener('click', exportApprovedToCSV);

      document.getElementById('btnDelete').addEventListener('click', () => {
        const dniList = collectDniFromTable('approvedRows');
        deleteByDniList(dniList);
      });

      document.getElementById('btnZipSunedu').addEventListener('click', generateZipForApproved);

      document.getElementById('btnMarkSentSunedu').addEventListener('click', () => {
        const dniList = collectDniFromTable('suneduRows');
        markSuneduSent(dniList);
      });

      document.getElementById('btnDeleteSunedu').addEventListener('click', () => {
        const dniList = collectDniFromTable('suneduRows');
        deleteByDniList(dniList);
      });

      // drawer buttons now LIVE
      document.getElementById('dGenerate').addEventListener('click', () => {
        if (!drawerRow || !drawerRow.dni) {
          toast('No se encontró DNI para este estudiante', true);
          return;
        }
        generateZipForDniList([drawerRow.dni]);
      });

      document.getElementById('dMarkSent').addEventListener('click', () => {
        if (!drawerRow || !drawerRow.dni) {
          toast('No se encontró DNI para este estudiante', true);
          return;
        }
        markSuneduSent([drawerRow.dni]);
      });

      // --- live search boxes ---
      const searchApproved = document.querySelector('#route-approved .search');
      const searchRejected = document.querySelector('#route-rejected .search');
      const searchSunedu = document.querySelector('#route-sunedu .search');

      if (searchApproved) {
        searchApproved.addEventListener('input', (e) => {
          currentFilters.approved = e.target.value;
          applyFilter('approved');
        });
      }

      if (searchRejected) {
        searchRejected.addEventListener('input', (e) => {
          currentFilters.rejected = e.target.value;
          applyFilter('rejected');
        });
      }

      if (searchSunedu) {
        searchSunedu.addEventListener('input', (e) => {
          currentFilters.sunedu = e.target.value;
          applyFilter('sunedu');
        });
      }

      // --- "select all" header checkboxes ---
      const selectAllApproved = document.getElementById('selectAllApproved');
      if (selectAllApproved) {
        selectAllApproved.addEventListener('change', (e) => {
          const checked = e.target.checked;
          const tbody = document.getElementById('approvedRows');
          if (!tbody) return;
          tbody.querySelectorAll('input[type="checkbox"][data-dni]').forEach(cb => {
            cb.checked = checked;
          });
          e.target.indeterminate = false;
        });
      }

      const selectAllSunedu = document.getElementById('selectAllSunedu');
      if (selectAllSunedu) {
        selectAllSunedu.addEventListener('change', (e) => {
          const checked = e.target.checked;
          const tbody = document.getElementById('suneduRows');
          if (!tbody) return;
          tbody.querySelectorAll('input[type="checkbox"][data-dni]').forEach(cb => {
            cb.checked = checked;
          });
          e.target.indeterminate = false;
        });
      }

      // update header checkbox when a row checkbox changes
      const approvedRowsEl = document.getElementById('approvedRows');
      if (approvedRowsEl) {
        approvedRowsEl.addEventListener('change', (e) => {
          if (e.target.matches('input[type="checkbox"][data-dni]')) {
            updateHeaderCheckbox('approved');
          }
        });
      }

      const suneduRowsEl = document.getElementById('suneduRows');
      if (suneduRowsEl) {
        suneduRowsEl.addEventListener('change', (e) => {
          if (e.target.matches('input[type="checkbox"][data-dni]')) {
            updateHeaderCheckbox('sunedu');
          }
        });
      }
 
      loadAdminData();
    })();
  </script>
</body>

</html>
