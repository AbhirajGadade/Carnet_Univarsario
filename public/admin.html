<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UMA — Panel de Administración</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary: #f02454;
      --primary-light: #ff6090;
      --primary-dark: #b0003a;

      --outline: #ffc2d0;
      --ring: #ffd3dd;

      --muted: #6b7280;
      --text: #0f172a;

      --card: #ffffff;
      --shadow: 0 4px 12px rgba(240, 36, 84, 0.08);
      --shadow-hover: 0 8px 24px rgba(240, 36, 84, 0.12);

      --radius: 12px;
      --radius-lg: 16px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: radial-gradient(circle at top left, #ffe3ee 0, #fffdfd 45%, #ffe3ee 100%);
      color: var(--text);
      font: 14px/1.55 "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .container {
      max-width: 1280px;
      margin: 24px auto;
      padding: 0 16px;
    }

    /* ===== HEADER (Student-portal style) ===== */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      background: var(--card);
      padding: 16px 20px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      border: 1px solid #ffe6ee;
      margin-bottom: 16px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 18px;
      min-width: 0;
    }

    .brand-logo-img {
      height: 64px;
      width: auto;
      object-fit: contain;
      background: transparent;
      box-shadow: none;
    }

    .brand-text { min-width: 0; }

    .brand-text h1 {
      margin: 0 0 4px 0;
      font-size: 1.55rem;
      line-height: 1.15;
      color: var(--text);
    }

    .brand-text p {
      margin: 0;
      color: var(--primary);
      font-size: 1rem;
      font-weight: 500;
    }

    .header-right {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 10px;
      flex-wrap: wrap;
    }

    .session-chip {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 18px;
      border-radius: 999px;
      background: #f3f4f6;
      font-size: 14px;
      color: #111827;
      white-space: nowrap;
      border: 1px solid #eef2f7;
    }

    .session-icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-size: 12px;
    }

    /* Mobile-only logout in header */
    .header-logout-btn {
      display: none; /* hidden on desktop */
      align-items: center;
      gap: 8px;
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(135deg, var(--primary-light), var(--primary));
      color: #fff;
      box-shadow: var(--shadow-hover);
      white-space: nowrap;
    }
    .header-logout-btn:hover { filter: brightness(1.03); }

    /* ===== APP LAYOUT ===== */
    .app {
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 18px;
    }

    .card {
      background: var(--card);
      border: 1px solid #ffe3ea;
      border-radius: 16px;
      box-shadow: var(--shadow);
    }

    .pad { padding: 16px; }

    .nav { padding: 10px; }

    .section {
      font-weight: 800;
      font-size: 12px;
      color: #4b5563;
      letter-spacing: .06em;
      margin: 8px 8px 6px;
    }

    .link {
      appearance: none;
      width: 100%;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      margin: 6px 0;
      border-radius: 12px;
      color: #0f172a;
      border: 1px solid transparent;
      cursor: pointer;
      background: #fff;
      text-align: left;
    }

    .link:hover {
      background: #fff5f7;
      border-color: #ffe3ea;
    }

    .link.active {
      outline: 3px solid var(--ring);
      border-color: var(--outline);
      background: #fff0f4;
    }

    .screen { display: none; }
    .screen.active { display: block; }

    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }

    .search {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #ffe0ea;
      padding: 8px 12px;
      font-size: 13px;
      background: #fff;
    }

    .btn {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid #f02454;
      background: linear-gradient(180deg, #f76385, #f02454);
      color: #fff;
      font-weight: 700;
      font-size: 13px;
      box-shadow: 0 8px 20px rgba(240, 36, 84, .18);
    }

    .btn.ghost {
      background: transparent;
      color: var(--primary);
      border-color: #ffe0e7;
      box-shadow: none;
    }

    .btn-danger {
      background: #f44336;
      border-color: #f44336;
      color: #fff;
      box-shadow: 0 8px 20px rgba(244, 67, 54, 0.25);
    }

    .btn-danger:hover {
      background: #d32f2f;
      border-color: #d32f2f;
    }

    .btn:disabled {
      opacity: .5;
      cursor: not-allowed;
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
    }

    /* ===== TABLES ===== */
    .table-scroll {
      width: 100%;
      overflow: visible; /* desktop unchanged */
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px;
    }

    thead th {
      padding: 8px 10px;
      text-align: left;
      color: #475569;
      font-size: 12px;
    }

    tbody tr {
      background: #ffffff;
      border: 1px solid #fce4ec;
    }

    tbody td {
      padding: 8px 10px;
      border-top: 1px solid #fde7f0;
      border-bottom: 1px solid #fde7f0;
      font-size: 13px;
    }

    tbody td:first-child {
      border-left: 1px solid #fde7f0;
      border-radius: 10px 0 0 10px;
    }

    tbody td:last-child {
      border-right: 1px solid #fde7f0;
      border-radius: 0 10px 10px 0;
    }

    .empty {
      padding: 16px;
      text-align: center;
      color: #9ca3af;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      font-size: 11px;
      border-radius: 999px;
      font-weight: 600;
    }

    .status-approved {
      background: #ecfdf5;
      color: #065f46;
      border: 1px solid #bbf7d0;
    }

    .status-rejected {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .status-pending {
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }

    #toast {
      position: fixed;
      right: 16px;
      bottom: 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      z-index: 9999;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 700;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--outline);
      background: #fff;
    }

    .pill.info {
      color: #a31231;
      background: #fff5f7;
    }

    /* Drawer */
    #drawer {
      position: fixed;
      top: 0;
      right: 0;
      width: 360px;
      max-width: 100%;
      height: 100%;
      background: #fff;
      border-left: 1px solid #ffe0ea;
      box-shadow: -10px 0 40px rgba(15, 23, 42, .2);
      transform: translateX(100%);
      transition: transform .25s ease;
      z-index: 9998;
      display: flex;
      flex-direction: column;
    }

    #drawer.open { transform: translateX(0); }

    #drawer header {
      padding: 14px 16px;
      border-bottom: 1px solid #fef0f4;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    #drawer main {
      padding: 16px;
      overflow-y: auto;
      flex: 1;
    }

    #drawer footer {
      padding: 12px 16px;
      border-top: 1px solid #fef0f4;
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    #drawer img {
      width: 140px;
      height: 180px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    .drawer-grid {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 12px;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .drawer-meta {
      font-size: 13px;
      display: grid;
      gap: 4px;
    }

    .drawer-label {
      font-size: 11px;
      text-transform: uppercase;
      color: #6b7280;
      letter-spacing: .06em;
      font-weight: 700;
    }

    .drawer-value {
      font-size: 13px;
      word-break: break-all;
    }

    .closeBtn {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      background: #fff;
    }

    /* Código + checkbox inline */
    .code-with-checkbox {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .code-with-checkbox input { margin: 0; }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 900px) {
      .app { grid-template-columns: 1fr; }
    }

    /* IMPORTANT: applies on phones even when CSS width is >768 */
    @media (max-width: 768px), (hover: none) and (pointer: coarse) {
      body { overflow-x: hidden; }
      .container { margin: 16px auto; padding: 0 12px; }

      /* Header like Student portal */
      .header {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }

      .brand { flex-direction: column; gap: 10px; }
      .header-right { justify-content: center; width: 100%; }

      /* Show header logout only on mobile */
      .header-logout-btn {
        display: inline-flex;
        width: 100%;
        max-width: 260px;
        justify-content: center;
      }

      /* Hide sidebar logout on mobile to avoid double logout */
      .link[data-route="logout"] { display: none !important; }

      /* Sidebar becomes a horizontal, swipeable tab bar */
      .nav {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        padding: 10px;
      }
      .nav::-webkit-scrollbar { display: none; }
      .nav { scrollbar-width: none; }

      /* Hide section headings (GESTIÓN / SUNEDU / SISTEMA) */
      .section { display: none; }

      .link {
        flex: 0 0 auto;
        margin: 0;
        white-space: nowrap;
        border-radius: 999px;
        padding: 10px 12px;
      }

      /* Toolbars wrap */
      .toolbar-left { flex-wrap: wrap; }
      .search { min-width: 220px; }

      /* Make tables horizontally scrollable on mobile */
      .table-scroll {
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        width: 100%;
      }

      /* Keep columns in one line so horizontal scroll works cleanly */
      .table-scroll th,
      .table-scroll td {
        white-space: nowrap;
      }

      /* Ensure table is wider than phone so it scrolls (no off-screen page) */
      .table-scroll table {
        min-width: 1100px;
      }
    }
  </style>
</head>

<body>
  <div class="container">

    <!-- Header (student-portal style) -->
    <div class="header">
      <div class="brand">
        <img src="assets/images/logo-pdf.png" alt="UMA" class="brand-logo-img" />
        <div class="brand-text">
          <h1>Panel Administrativo UMA</h1>
          <p>Gestión de solicitudes y fotos</p>
        </div>
      </div>

      <div class="header-right">
        <div class="session-chip" id="sessionChip">
          <div class="session-icon"><i class="fas fa-user"></i></div>
          <span>Conectado</span>
        </div>

        <!-- Mobile-only logout -->
        <button type="button" class="header-logout-btn" id="logoutBtnHeader">
          <i class="fas fa-right-from-bracket"></i>
          <span>Cerrar sesión</span>
        </button>
      </div>
    </div>

    <div class="app">
      <aside class="card">
        <nav class="nav" id="sideNav">
          <div class="section">GESTIÓN</div>
          <button type="button" class="link" data-route="approved">Solicitudes Aprobadas</button>
          <button type="button" class="link" data-route="rejected">Solicitudes Rechazadas</button>

          <div class="section">SUNEDU</div>
          <button type="button" class="link" data-route="sunedu">Envíos y Paquetes</button>

          <div class="section">SISTEMA</div>
          <!-- Desktop logout (hidden on mobile by CSS) -->
          <button type="button" class="link" data-route="logout">Cerrar sesión</button>
        </nav>
      </aside>

      <main>
        <!-- Aprobadas -->
        <section id="route-approved" class="card pad screen active">
          <div class="toolbar">
            <div class="toolbar-left">
              <input type="text" class="search" placeholder="Buscar por código, nombre, correo o DNI…">
              <button id="exportCSV" class="btn ghost" type="button">Exportar CSV</button>
              <span class="muted" id="countApproved">0 resultado(s)</span>
            </div>
          </div>

          <div class="toolbar" style="margin-top:4px;margin-bottom:8px;">
            <div class="toolbar-left">
              <button class="btn btn-danger" id="btnDelete" type="button">Eliminar seleccionados</button>
            </div>
          </div>

          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th>
                    <label class="code-with-checkbox">
                      <input type="checkbox" id="selectAllApproved">
                      <span>Código</span>
                    </label>
                  </th>
                  <th>Nombre</th>
                  <th>Correo</th>
                  <th>FACULTAD</th>
                  <th>CARRERA</th>
                  <th>IA</th>
                  <th>Supabase URL</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="approvedRows"></tbody>
            </table>
          </div>
        </section>

        <!-- Rechazadas -->
        <section id="route-rejected" class="card pad screen">
          <div class="toolbar">
            <div class="toolbar-left">
              <input type="text" class="search" placeholder="Buscar por código, nombre, correo o DNI…">
              <span class="muted" id="countRejected">0 resultado(s)</span>
            </div>
          </div>

          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th>Código</th>
                  <th>Nombre</th>
                  <th>Correo</th>
                  <th>FACULTAD</th>
                  <th>CARRERA</th>
                  <th>Motivo</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="rejectedRows"></tbody>
            </table>
          </div>
        </section>

        <!-- SUNEDU -->
        <section id="route-sunedu" class="card pad screen">
          <div class="toolbar">
            <div class="toolbar-left">
              <input type="text" class="search" placeholder="Buscar…">
              <span class="muted" id="countSunedu">0 aprobado(s)</span>
            </div>
          </div>

          <div class="toolbar" style="margin-top:4px;margin-bottom:8px;">
            <div class="toolbar-left">
              <button class="btn" id="btnZipSunedu" type="button">Generar Paquetes (SUNEDU)</button>
              <button class="btn ghost" id="btnMarkSentSunedu" type="button">Marcar como Enviado</button>
              <button class="btn btn-danger" id="btnDeleteSunedu" type="button">Eliminar seleccionados</button>
            </div>
          </div>

          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th>
                    <label class="code-with-checkbox">
                      <input type="checkbox" id="selectAllSunedu">
                      <span>Código</span>
                    </label>
                  </th>
                  <th>Nombre</th>
                  <th>DNI</th>
                  <th>Estado SUNEDU</th>
                  <th>Actualizado</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="suneduRows"></tbody>
            </table>
          </div>
        </section>
      </main>
    </div>
  </div>

  <div id="toast"></div>

  <!-- Drawer detalle estudiante -->
  <aside id="drawer">
    <header>
      <div>
        <div id="dTitle" style="font-weight:700;font-size:15px;">Estudiante</div>
        <div id="dSub" class="muted" style="font-size:12px;">Detalle de solicitud</div>
      </div>
      <button id="closeDrawer" class="closeBtn" type="button">Cerrar</button>
    </header>

    <main>
      <div class="drawer-grid">
        <img id="dPhoto" alt="Foto" />
        <div class="drawer-meta">
          <div>
            <span class="drawer-label">IA</span>
            <div id="dAI" class="drawer-value"></div>
          </div>
          <div>
            <span class="drawer-label">SUNEDU</span>
            <div id="dSunedu" class="drawer-value"></div>
          </div>
          <div>
            <span class="drawer-label">Actualizado</span>
            <div id="dUpdated" class="drawer-value"></div>
          </div>
        </div>
      </div>

      <div class="drawer-meta">
        <div><span class="drawer-label">Código</span><div id="dCode" class="drawer-value">—</div></div>
        <div><span class="drawer-label">Nombre</span><div id="dName" class="drawer-value">—</div></div>
        <div><span class="drawer-label">DNI</span><div id="dDni" class="drawer-value">—</div></div>
        <div><span class="drawer-label">Correo</span><div id="dEmail" class="drawer-value">—</div></div>
        <div><span class="drawer-label">FACULTAD</span><div id="dFac" class="drawer-value">—</div></div>
        <div><span class="drawer-label">CARRERA</span><div id="dCarr" class="drawer-value">—</div></div>
        <div><span class="drawer-label">URL Supabase</span><div id="dSupabase" class="drawer-value">—</div></div>
      </div>
    </main>

    <footer>
      <button id="dGenerate" class="btn" type="button">Generar ZIP</button>
      <button id="dMarkSent" class="btn ghost" type="button">Marcar como Enviado</button>
    </footer>
  </aside>

  <script>
    (function () {
      const TOKEN_KEY = 'uma_token_admin';
      let datasets = { approved: [], rejected: [], sunedu: [] };
      let currentFilters = { approved: '', rejected: '', sunedu: '' };
      let drawerRow = null;

      function toast(m, err) {
        const el = document.createElement('div');
        el.className = 'pill' + (err ? ' info' : '');
        el.textContent = m;
        document.getElementById('toast').appendChild(el);
        setTimeout(() => el.remove(), 4000);
      }

      function doLogout() {
        localStorage.clear();
        location.replace('index.html');
      }

      // Mobile header logout
      const logoutBtnHeader = document.getElementById('logoutBtnHeader');
      if (logoutBtnHeader) logoutBtnHeader.addEventListener('click', doLogout);

      // Session chip
      (function guard() {
        const role = localStorage.getItem('uma_session_role');
        const email = localStorage.getItem('uma_session_email') || '';
        const code = localStorage.getItem('uma_session_code') || '';
        const chip = document.getElementById('sessionChip');
        const span = chip.querySelector('span');

        if (role !== 'admin' || !localStorage.getItem(TOKEN_KEY)) {
          span.textContent = 'Modo demo admin';
          return;
        }

        const who = code || email || 'admin';
        span.textContent = `Conectado: ${who}`;
      })();

      function goto(hash) {
        document.querySelectorAll('.link').forEach(b => b.classList.remove('active'));
        document.querySelector(`.link[data-route="${hash}"]`)?.classList.add('active');
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('route-' + hash).classList.add('active');
      }

      document.getElementById('sideNav').addEventListener('click', (e) => {
        const btn = e.target.closest('button.link');
        if (!btn) return;
        if (btn.dataset.route === 'logout') {
          doLogout();
          return;
        }
        goto(btn.dataset.route);
      });

      goto('approved');

      // Drawer refs
      const drawer = document.getElementById('drawer');
      const dTitle = document.getElementById('dTitle');
      const dSub = document.getElementById('dSub');
      const dPhoto = document.getElementById('dPhoto');
      const dAI = document.getElementById('dAI');
      const dSunedu = document.getElementById('dSunedu');
      const dName = document.getElementById('dName');
      const dDni = document.getElementById('dDni');
      const dEmail = document.getElementById('dEmail');
      const dFac = document.getElementById('dFac');
      const dCarr = document.getElementById('dCarr');
      const dUpdated = document.getElementById('dUpdated');
      const dCode = document.getElementById('dCode');
      const dSupabase = document.getElementById('dSupabase');

      document.getElementById('closeDrawer').addEventListener('click', () => drawer.classList.remove('open'));

      function getPhotoUrl(row) {
        if (row.photoUrl) return row.photoUrl;
        if (row.supabase_url) return row.supabase_url;

        if (row.relative_path) {
          const p = String(row.relative_path);
          return p.startsWith('/') ? p : '/' + p;
        }

        if (row.dni) return '/photos/approved/' + row.dni + '.jpg';
        return '';
      }

      function openDrawer(kind, row) {
        drawerRow = row;

        dTitle.textContent = row.name || 'Estudiante';
        dSub.textContent = kind === 'rejected' ? 'Solicitud rechazada' : 'Solicitud aprobada';

        const photoUrl = getPhotoUrl(row);
        dPhoto.src = photoUrl || '';
        dPhoto.alt = 'Foto';

        const ok = row.category === 'approved';

        dAI.textContent = ok ? 'Aprobada por IA' : 'Rechazada por IA';
        dAI.className = 'status-badge ' + (ok ? 'status-approved' : 'status-rejected');

        const sunStatus = row.suneduStatus || 'Pendiente';
        dSunedu.textContent = sunStatus;
        dSunedu.className = 'status-badge ' + (sunStatus === 'Enviado' ? 'status-approved' : 'status-pending');

        dCode.textContent = row.code || row.codigo || '—';
        dName.textContent = row.name || '—';
        dDni.textContent = row.dni || '—';
        dEmail.textContent = row.email || '—';
        dFac.textContent = row.facultad || row.faculty || '—';
        dCarr.textContent = row.carrera || row.esp || '—';
        dUpdated.textContent = row.updatedAt ? new Date(row.updatedAt).toLocaleString('es-PE') : '—';

        const linkUrl = row.supabase_url || photoUrl;
        if (linkUrl) dSupabase.innerHTML = `<a href="${linkUrl}" target="_blank" rel="noopener">Abrir foto</a>`;
        else dSupabase.textContent = '—';

        drawer.classList.add('open');
      }

      function renderEmptyRow(tbodyId, colSpan, text) {
        const tb = document.getElementById(tbodyId);
        tb.innerHTML = `<tr><td colspan="${colSpan}"><div class="empty">${text}</div></td></tr>`;
      }

      function renderTable(tbodyId, rows, kind, ds) {
        const tb = document.getElementById(tbodyId);

        if (!rows.length) {
          if (kind === 'approved') renderEmptyRow(tbodyId, 8, 'Sin solicitudes aprobadas aún.');
          else if (kind === 'rejected') renderEmptyRow(tbodyId, 7, 'Sin solicitudes rechazadas.');
          else renderEmptyRow(tbodyId, 6, 'No hay aprobados para SUNEDU.');
          return;
        }

        if (kind === 'approved') {
          tb.innerHTML = rows.map((r, i) => {
            const iaOk = r.category === 'approved';
            const code = r.code || r.codigo || '—';
            const name = r.name || '—';
            const email = r.email || '—';
            const facultad = r.facultad || r.faculty || '—';
            const carrera = r.carrera || r.esp || '—';

            const linkUrl = r.supabase_url || getPhotoUrl(r);
            const supaLink = linkUrl ? `<a href="${linkUrl}" target="_blank" rel="noopener">Abrir</a>` : '—';

            return `
              <tr>
                <td>
                  <label class="code-with-checkbox">
                    <input type="checkbox" data-dni="${r.dni || ''}">
                    <span>${code}</span>
                  </label>
                </td>
                <td>${name}</td>
                <td>${email}</td>
                <td>${facultad}</td>
                <td>${carrera}</td>
                <td>
                  <span class="status-badge ${iaOk ? 'status-approved' : 'status-rejected'}">
                    ${iaOk ? 'Aprobada por IA' : 'Rechazada por IA'}
                  </span>
                </td>
                <td>${supaLink}</td>
                <td><button class="btn ghost viewBtn" data-kind="approved" data-index="${i}" type="button">Ver</button></td>
              </tr>`;
          }).join('');
        } else if (kind === 'rejected') {
          tb.innerHTML = rows.map((r, i) => `
            <tr>
              <td>${r.code || r.codigo || '—'}</td>
              <td>${r.name || '—'}</td>
              <td>${r.email || '—'}</td>
              <td>${r.facultad || r.faculty || '—'}</td>
              <td>${r.carrera || r.esp || '—'}</td>
              <td>${(r.issues && r.issues.join(' | ')) || '—'}</td>
              <td><button class="btn ghost viewBtn" data-kind="rejected" data-index="${i}" type="button">Ver</button></td>
            </tr>`).join('');
        } else if (kind === 'sunedu') {
          tb.innerHTML = rows.map((r, i) => `
            <tr>
              <td>
                <label class="code-with-checkbox">
                  <input type="checkbox" data-dni="${r.dni || ''}">
                  <span>${r.codigo || r.code || '—'}</span>
                </label>
              </td>
              <td>${r.name || '—'}</td>
              <td>${r.dni || '—'}</td>
              <td>
                <span class="status-badge ${r.suneduStatus === 'Enviado' ? 'status-approved' : 'status-pending'}">
                  ${r.suneduStatus || 'Pendiente'}
                </span>
              </td>
              <td>${r.updatedAt ? new Date(r.updatedAt).toLocaleString('es-PE') : '—'}</td>
              <td><button class="btn ghost viewBtn" data-kind="sunedu" data-index="${i}" type="button">Ver</button></td>
            </tr>`).join('');
        }

        tb.querySelectorAll('.viewBtn').forEach(btn => {
          const kindBtn = btn.dataset.kind;
          const idx = parseInt(btn.dataset.index, 10);
          btn.addEventListener('click', () => {
            const srcArr = ds[kindBtn] || [];
            const row = srcArr[idx];
            if (row) openDrawer(kindBtn, row);
          });
        });
      }

      function filterRows(kind, term) {
        const base = datasets[kind] || [];
        const q = (term || '').trim().toLowerCase();
        if (!q) return base;

        return base.filter(r => {
          const parts = [
            r.code || r.codigo,
            r.dni,
            r.name,
            r.email,
            r.facultad || r.faculty,
            r.carrera || r.esp
          ];
          const haystack = parts.filter(Boolean).map(v => String(v).toLowerCase()).join(' ');
          return haystack.includes(q);
        });
      }

      function applyFilter(kind) {
        const term = currentFilters[kind] || '';
        const filtered = filterRows(kind, term);

        if (kind === 'approved') {
          renderTable('approvedRows', filtered, 'approved', { approved: filtered });
          document.getElementById('countApproved').textContent = `${filtered.length} resultado(s)`;
          updateHeaderCheckbox('approved');
        } else if (kind === 'rejected') {
          renderTable('rejectedRows', filtered, 'rejected', { rejected: filtered });
          document.getElementById('countRejected').textContent = `${filtered.length} resultado(s)`;
        } else if (kind === 'sunedu') {
          renderTable('suneduRows', filtered, 'sunedu', { sunedu: filtered });
          document.getElementById('countSunedu').textContent = `${filtered.length} aprobado(s)`;
          updateHeaderCheckbox('sunedu');
        }
      }

      async function loadAdminData() {
        try {
          const r = await fetch('/api/admin/submissions');
          const ct = r.headers.get('content-type') || '';
          let j;
          if (ct.includes('application/json')) j = await r.json();
          else {
            const text = await r.text();
            throw new Error('Respuesta no válida del servidor: ' + text.slice(0, 120));
          }

          if (!r.ok || !j.ok) throw new Error(j.error || 'No se pudo cargar datos');

          const approved = j.data?.approved || [];
          const rejected = j.data?.rejected || [];
          const sunedu = approved.map((row, i) => ({
            ...row,
            codigo: row.code || row.codigo || ('A' + (i + 1))
          }));

          datasets = { approved, rejected, sunedu };
          applyFilter('approved');
          applyFilter('rejected');
          applyFilter('sunedu');
        } catch (e) {
          toast('No se pudo cargar datos admin', true);
          console.warn(e);
        }
      }

      async function generateZipForDniList(dniList) {
        try {
          const r = await fetch('/api/admin/generate-zip', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dniList })
          });

          const ct = r.headers.get('content-type') || '';
          let j;
          if (ct.includes('application/json')) j = await r.json();
          else {
            const text = await r.text();
            throw new Error('Respuesta no válida del servidor: ' + text.slice(0, 120));
          }

          if (!r.ok || !j.ok) throw new Error(j.error || 'No se pudo generar el ZIP');

          toast(`ZIP generado con ${j.total} estudiante(s)`, false);

          if (j.url) {
            const a = document.createElement('a');
            a.href = j.url;
            a.download = '';
            document.body.appendChild(a);
            a.click();
            a.remove();
          }
        } catch (err) {
          console.error(err);
          toast(err.message || 'Error generando ZIP', true);
        }
      }

      async function generateZipForApproved() {
        const tbody = document.getElementById('suneduRows');
        const boxes = Array.from(tbody.querySelectorAll('input[type="checkbox"][data-dni]'));
        const dniList = boxes.filter(b => b.checked && b.dataset.dni).map(b => b.dataset.dni);
        if (!dniList.length) return toast('Selecciona al menos un estudiante en SUNEDU', true);
        await generateZipForDniList(dniList);
      }

      async function markSuneduSent(dniList) {
        try {
          if (!dniList.length) return toast('Selecciona al menos un estudiante', true);

          const r = await fetch('/api/admin/mark-sunedu-sent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dniList })
          });

          const ct = r.headers.get('content-type') || '';
          let j;
          if (ct.includes('application/json')) j = await r.json();
          else {
            const text = await r.text();
            throw new Error('Respuesta no válida del servidor: ' + text.slice(0, 120));
          }

          if (!r.ok || !j.ok) throw new Error(j.error || 'No se pudo marcar como enviado');

          toast(`Se marcaron ${j.updated || dniList.length} registro(s) como Enviado`, false);
          await loadAdminData();
        } catch (err) {
          console.error(err);
          toast(err.message || 'Error marcando como enviado', true);
        }
      }

      async function deleteByDniList(dniList) {
        try {
          if (!dniList.length) return toast('Selecciona al menos un estudiante', true);
          if (!confirm('¿Eliminar las solicitudes seleccionadas? Esta acción no se puede deshacer.')) return;

          const r = await fetch('/api/admin/delete-submissions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dniList })
          });

          const ct = r.headers.get('content-type') || '';
          let j;
          if (ct.includes('application/json')) j = await r.json();
          else {
            const text = await r.text();
            throw new Error('Respuesta no válida del servidor: ' + text.slice(0, 120));
          }

          if (!r.ok || !j.ok) throw new Error(j.error || 'No se pudo eliminar');

          toast(`Se eliminaron ${j.deleted} registro(s).`, false);
          await loadAdminData();
        } catch (err) {
          console.error(err);
          toast(err.message || 'Error eliminando registros', true);
        }
      }

      function collectDniFromTable(tbodyId) {
        const tbody = document.getElementById(tbodyId);
        const boxes = Array.from(tbody.querySelectorAll('input[type="checkbox"][data-dni]'));
        return boxes.filter(b => b.checked && b.dataset.dni).map(b => b.dataset.dni);
      }

      function updateHeaderCheckbox(kind) {
        const headerId = kind === 'approved' ? 'selectAllApproved' : kind === 'sunedu' ? 'selectAllSunedu' : null;
        const tbodyId = kind === 'approved' ? 'approvedRows' : kind === 'sunedu' ? 'suneduRows' : null;
        if (!headerId || !tbodyId) return;

        const header = document.getElementById(headerId);
        const tbody = document.getElementById(tbodyId);
        if (!header || !tbody) return;

        const boxes = Array.from(tbody.querySelectorAll('input[type="checkbox"][data-dni]'));
        if (!boxes.length) { header.checked = false; header.indeterminate = false; return; }

        const checkedCount = boxes.filter(b => b.checked).length;
        header.checked = checkedCount === boxes.length;
        header.indeterminate = checkedCount > 0 && checkedCount < boxes.length;
      }

      function exportApprovedToCSV() {
        const rows = datasets.approved || [];
        if (!rows.length) return toast('No hay solicitudes aprobadas para exportar', true);

        const header = ['Código', 'DNI', 'Nombre', 'Correo', 'FACULTAD', 'CARRERA', 'Supabase URL'];
        const csvLines = [header.join(',')];

        rows.forEach((r) => {
          const code = r.code || r.codigo || '';
          const dni = r.dni || '';
          const name = r.name || '';
          const email = r.email || '';
          const facultad = r.facultad || r.faculty || '';
          const carrera = r.carrera || r.esp || '';
          const supabase = r.supabase_url || getPhotoUrl(r) || '';

          const values = [code, dni, name, email, facultad, carrera, supabase].map(v =>
            '"' + String(v ?? '').replace(/"/g, '""') + '"'
          );
          csvLines.push(values.join(','));
        });

        const blob = new Blob(['\uFEFF' + csvLines.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');

        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');

        a.href = url;
        a.download = `uma_solicitudes_aprobadas_${y}${m}${d}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      document.getElementById('exportCSV').addEventListener('click', exportApprovedToCSV);

      document.getElementById('btnDelete').addEventListener('click', () => {
        deleteByDniList(collectDniFromTable('approvedRows'));
      });

      document.getElementById('btnZipSunedu').addEventListener('click', generateZipForApproved);

      document.getElementById('btnMarkSentSunedu').addEventListener('click', () => {
        markSuneduSent(collectDniFromTable('suneduRows'));
      });

      document.getElementById('btnDeleteSunedu').addEventListener('click', () => {
        deleteByDniList(collectDniFromTable('suneduRows'));
      });

      document.getElementById('dGenerate').addEventListener('click', () => {
        if (!drawerRow || !drawerRow.dni) return toast('No se encontró DNI para este estudiante', true);
        generateZipForDniList([drawerRow.dni]);
      });

      document.getElementById('dMarkSent').addEventListener('click', () => {
        if (!drawerRow || !drawerRow.dni) return toast('No se encontró DNI para este estudiante', true);
        markSuneduSent([drawerRow.dni]);
      });

      const searchApproved = document.querySelector('#route-approved .search');
      const searchRejected = document.querySelector('#route-rejected .search');
      const searchSunedu = document.querySelector('#route-sunedu .search');

      if (searchApproved) {
        searchApproved.addEventListener('input', (e) => {
          currentFilters.approved = e.target.value;
          applyFilter('approved');
        });
      }
      if (searchRejected) {
        searchRejected.addEventListener('input', (e) => {
          currentFilters.rejected = e.target.value;
          applyFilter('rejected');
        });
      }
      if (searchSunedu) {
        searchSunedu.addEventListener('input', (e) => {
          currentFilters.sunedu = e.target.value;
          applyFilter('sunedu');
        });
      }

      const selectAllApproved = document.getElementById('selectAllApproved');
      if (selectAllApproved) {
        selectAllApproved.addEventListener('change', (e) => {
          const checked = e.target.checked;
          const tbody = document.getElementById('approvedRows');
          if (!tbody) return;
          tbody.querySelectorAll('input[type="checkbox"][data-dni]').forEach(cb => cb.checked = checked);
          e.target.indeterminate = false;
        });
      }

      const selectAllSunedu = document.getElementById('selectAllSunedu');
      if (selectAllSunedu) {
        selectAllSunedu.addEventListener('change', (e) => {
          const checked = e.target.checked;
          const tbody = document.getElementById('suneduRows');
          if (!tbody) return;
          tbody.querySelectorAll('input[type="checkbox"][data-dni]').forEach(cb => cb.checked = checked);
          e.target.indeterminate = false;
        });
      }

      const approvedRowsEl = document.getElementById('approvedRows');
      if (approvedRowsEl) {
        approvedRowsEl.addEventListener('change', (e) => {
          if (e.target.matches('input[type="checkbox"][data-dni]')) updateHeaderCheckbox('approved');
        });
      }

      const suneduRowsEl = document.getElementById('suneduRows');
      if (suneduRowsEl) {
        suneduRowsEl.addEventListener('change', (e) => {
          if (e.target.matches('input[type="checkbox"][data-dni]')) updateHeaderCheckbox('sunedu');
        });
      }

      loadAdminData();
    })();
  </script>
</body>

</html>
